package Code;

import javax.swing.*;
import java.awt.*;
import java.util.ArrayList;

public class ManagePurchasesGUI extends JFrame implements EmailNotif{
    private JFrame frame;
    private JPanel mainPanel;

    public ManagePurchasesGUI() {
        // Initialize components
        frame = new JFrame("Manage Purchases");
        frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        frame.setSize(700, 450);

        mainPanel = new JPanel();
        mainPanel.setLayout(new BoxLayout(mainPanel, BoxLayout.Y_AXIS));

        displayPurchases();

        JScrollPane scrollPane = new JScrollPane(mainPanel);
        frame.getContentPane().add(BorderLayout.CENTER, scrollPane);
    }

    private void displayPurchases() {
        ArrayList<Purchase> purchases = DatabaseController.getPurchases(User.getEmail());
    
        for (Purchase purchase : purchases) {
            JPanel purchasePanel = new JPanel();
            purchasePanel.setLayout(new BoxLayout(purchasePanel, BoxLayout.X_AXIS));
    
            // Display purchase information using Purchase class functions
            JTextArea purchaseInfo = new JTextArea();
            purchaseInfo.append("Name: " + purchase.getFirstName() + " " + purchase.getLastName() + "\n");
            purchaseInfo.append("Flight Number: " + purchase.getFlightNumber() + "\n");
            purchaseInfo.append("Seat Number: " + purchase.getSeatNumber() + "\n");
            purchaseInfo.append("Flight Start: " + purchase.getFlightStart() + "\n");
            purchaseInfo.append("Flight Destination: " + purchase.getFlightDestination() + "\n");
            purchaseInfo.append("Departure Date: " + purchase.getDepartureDate().getFormattedDate() + "\n");
    
            purchaseInfo.setEditable(false);
            purchaseInfo.setLineWrap(true);
            purchasePanel.add(purchaseInfo);
    
            // Add some space between purchase information and the "Cancel" button
            purchasePanel.add(Box.createRigidArea(new Dimension(10, 0)));
    
            // Create a "Cancel" button for each purchase
            JButton cancelButton = new JButton("Cancel");
            cancelButton.addActionListener(e -> handleCancelAction(purchase));
            purchasePanel.add(cancelButton);
    
            // Add some space between purchases
            mainPanel.add(purchasePanel);
            mainPanel.add(Box.createRigidArea(new Dimension(0, 5))); // Adjust as needed
        }
    }
    
    private void handleCancelAction(Purchase purchase) {
        // Display a confirmation dialog
        if(purchase.getInsurance()) {
            int option = JOptionPane.showConfirmDialog(
                frame,
                "Are you sure you want to cancel the purchase?\n$" + purchase.getPrice() + " will be refunded to your account",
                "Cancel Purchase",
                JOptionPane.YES_NO_OPTION);
                if (option == JOptionPane.YES_OPTION) {
                    // User clicked "Yes," implement the action to cancel the purchase
                    System.out.println("Cancel action for: " + purchase.getFirstName() + " " + purchase.getLastName());
                }
        } else {
            int option = JOptionPane.showConfirmDialog(
                frame,
                "Are you sure you want to cancel the purchase?",
                "Cancel Purchase",
                JOptionPane.YES_NO_OPTION);
            // Check user's choice
            if (option == JOptionPane.YES_OPTION) {
                // User clicked "Yes," implement the action to cancel the purchase
                System.out.println("Cancel action for: " + purchase.getFirstName() + " " + purchase.getLastName());
            }
        }

        int rowsDeleted = DatabaseController.CancelBooking(purchase);
        if(rowsDeleted != 0) {
            JOptionPane.showConfirmDialog(
                frame,
                "Booking cancelled successfully",
                "Booking Cancelled",
                JOptionPane.CLOSED_OPTION);

                frame.dispose();
        }
        User.removePurchase(purchase);
        
    }

    public void display() {
        // Show the frame
        SwingUtilities.invokeLater(() -> {
            frame.setVisible(true);
        });
    }

    public void sendEmail() {
        // IMPLEMENT SIGN UP CONFIMRATION EMAIL
        // Send email to USER.getEmail()
    }
}